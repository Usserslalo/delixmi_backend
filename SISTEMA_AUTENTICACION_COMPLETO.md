# üîê Sistema de Autenticaci√≥n Completo - Delixmi Backend

## üìã √çndice
1. [Resumen de Cambios](#resumen-de-cambios)
2. [Endpoints Disponibles](#endpoints-disponibles)
3. [Flujo de Autenticaci√≥n](#flujo-de-autenticaci√≥n)
4. [Tokens y Seguridad](#tokens-y-seguridad)
5. [Manejo de Errores](#manejo-de-errores)
6. [Rate Limiting](#rate-limiting)
7. [Validaciones](#validaciones)
8. [Ejemplos de Uso](#ejemplos-de-uso)
9. [Consideraciones de Frontend](#consideraciones-de-frontend)

---

## üîÑ Resumen de Cambios

### **Nuevas Caracter√≠sticas Implementadas:**
- ‚úÖ **Refresh Tokens** para sesiones persistentes
- ‚úÖ **Rate Limiting** para prevenir abuso
- ‚úÖ **Validaci√≥n robusta** con Zod
- ‚úÖ **Manejo de errores** centralizado
- ‚úÖ **Content Security Policy** mejorada
- ‚úÖ **Logging detallado** para debugging
- ‚úÖ **Verificaci√≥n de email** con p√°gina web
- ‚úÖ **Restablecimiento de contrase√±a** completo

### **Cambios en Seguridad:**
- üîí **JWT con expiraci√≥n corta** (15 minutos por defecto)
- üîí **Refresh tokens rotativos** (30 d√≠as por defecto)
- üîí **Rate limiting** en endpoints cr√≠ticos
- üîí **Validaci√≥n estricta** de datos de entrada
- üîí **CSP** para prevenir XSS

---

## üåê Endpoints Disponibles

### **Base URL:** `https://delixmi-backend.onrender.com`

### **1. Registro de Usuario**
```http
POST /api/auth/register
Content-Type: application/json

{
    "name": "Eduardo",
    "lastname": "Simon", 
    "email": "usuario@example.com",
    "phone": "5555555555",
    "password": "Password123!"
}
```

**Respuesta Exitosa (201):**
```json
{
    "status": "success",
    "message": "Usuario registrado exitosamente. Por favor, verifica tu correo electr√≥nico para activar tu cuenta.",
    "timestamp": "2025-10-17T04:48:29.795Z",
    "data": {
        "user": {
            "id": 12,
            "name": "Eduardo",
            "lastname": "Simon",
            "email": "usuario@example.com",
            "phone": "5555555555",
            "status": "pending",
            "createdAt": "2025-10-17T04:48:29.217Z"
        },
        "emailSent": true
    }
}
```

### **2. Inicio de Sesi√≥n**
```http
POST /api/auth/login
Content-Type: application/json

{
    "email": "usuario@example.com",
    "password": "Password123!"
}
```

**Respuesta Exitosa (200):**
```json
{
    "status": "success",
    "message": "Inicio de sesi√≥n exitoso",
    "data": {
        "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "refreshToken": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0...",
        "user": {
            "id": 12,
            "name": "Eduardo",
            "lastname": "Simon",
            "email": "usuario@example.com",
            "phone": "5555555555",
            "status": "active",
            "emailVerifiedAt": "2025-10-17T04:48:30.000Z",
            "phoneVerifiedAt": null,
            "createdAt": "2025-10-17T04:48:29.217Z",
            "updatedAt": "2025-10-17T04:48:30.000Z",
            "roles": [
                {
                    "roleId": 1,
                    "roleName": "customer",
                    "roleDisplayName": "Cliente",
                    "restaurantId": null,
                    "branchId": null
                }
            ]
        },
        "expiresIn": "15m"
    }
}
```

### **3. Renovar Access Token**
```http
POST /api/auth/refresh-token
Content-Type: application/json
Authorization: Bearer ACCESS_TOKEN_EXPIRADO

{
    "refreshToken": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0..."
}
```

**Respuesta Exitosa (200):**
```json
{
    "status": "success",
    "message": "Tokens renovados exitosamente",
    "data": {
        "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "refreshToken": "nuevo_refresh_token_aqui...",
        "expiresIn": "15m"
    }
}
```

### **4. Cerrar Sesi√≥n**
```http
POST /api/auth/logout
Content-Type: application/json

{
    "refreshToken": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0..."
}
```

### **5. Verificar Email**
```http
GET /api/auth/verify-email?token=TOKEN_DE_VERIFICACION
```

**Respuesta Exitosa (200):**
```json
{
    "status": "success",
    "message": "Tu cuenta ha sido verificada con √©xito. Ya puedes iniciar sesi√≥n.",
    "data": {
        "user": {
            "id": 12,
            "email": "usuario@example.com",
            "name": "Eduardo",
            "status": "active",
            "emailVerifiedAt": "2025-10-17T04:48:30.000Z"
        },
        "verified": true
    }
}
```

### **6. Reenviar Verificaci√≥n**
```http
POST /api/auth/resend-verification
Content-Type: application/json

{
    "email": "usuario@example.com"
}
```

### **7. Solicitar Reset de Contrase√±a**
```http
POST /api/auth/forgot-password
Content-Type: application/json

{
    "email": "usuario@example.com"
}
```

### **8. Reset de Contrase√±a**
```http
POST /api/auth/reset-password
Content-Type: application/json

{
    "token": "TOKEN_DE_RESET",
    "newPassword": "NuevaPassword123!"
}
```

### **9. Cambiar Contrase√±a (Autenticado)**
```http
PUT /api/auth/change-password
Content-Type: application/json
Authorization: Bearer ACCESS_TOKEN

{
    "currentPassword": "PasswordActual123!",
    "newPassword": "NuevaPassword123!"
}
```

### **10. Obtener Perfil**
```http
GET /api/auth/profile
Authorization: Bearer ACCESS_TOKEN
```

### **11. Actualizar Perfil**
```http
PUT /api/auth/profile
Content-Type: application/json
Authorization: Bearer ACCESS_TOKEN

{
    "name": "Nuevo Nombre",
    "lastname": "Nuevo Apellido",
    "phone": "5555555556"
}
```

### **12. Verificar Token**
```http
GET /api/auth/verify
Authorization: Bearer ACCESS_TOKEN
```

---

## üîÑ Flujo de Autenticaci√≥n

### **1. Registro y Verificaci√≥n:**
```
1. Usuario se registra ‚Üí POST /api/auth/register
2. Recibe email de verificaci√≥n
3. Hace clic en enlace ‚Üí GET /email-verification?token=...
4. P√°gina web verifica autom√°ticamente ‚Üí GET /api/auth/verify-email
5. Usuario puede iniciar sesi√≥n
```

### **2. Login y Sesi√≥n Persistente:**
```
1. Usuario hace login ‚Üí POST /api/auth/login
2. Recibe accessToken (15min) + refreshToken (30 d√≠as)
3. Usa accessToken para requests autenticados
4. Cuando accessToken expira, usa refreshToken ‚Üí POST /api/auth/refresh-token
5. Recibe nuevo accessToken + nuevo refreshToken
6. Contin√∫a usando la app sin re-login
```

### **3. Logout:**
```
1. Usuario hace logout ‚Üí POST /api/auth/logout
2. Env√≠a refreshToken para invalidarlo
3. Elimina tokens del cliente
4. Usuario debe hacer login nuevamente
```

---

## üîê Tokens y Seguridad

### **Access Token:**
- **Duraci√≥n:** 15 minutos (configurable)
- **Uso:** Autenticaci√≥n en requests
- **Header:** `Authorization: Bearer ACCESS_TOKEN`
- **Contenido:** userId, roleId, roleName, email

### **Refresh Token:**
- **Duraci√≥n:** 30 d√≠as (configurable)
- **Uso:** Renovar access tokens
- **Almacenamiento:** Base de datos (hasheado)
- **Rotaci√≥n:** Se genera uno nuevo en cada renovaci√≥n

### **Token de Verificaci√≥n de Email:**
- **Duraci√≥n:** 1 hora
- **Uso:** Verificar cuentas de email
- **URL:** `/email-verification?token=...`

### **Token de Reset de Contrase√±a:**
- **Duraci√≥n:** 15 minutos
- **Uso:** Restablecer contrase√±as
- **Almacenamiento:** Base de datos (hasheado)

---

## ‚ö†Ô∏è Manejo de Errores

### **C√≥digos de Error Comunes:**

#### **400 - Bad Request:**
```json
{
    "status": "error",
    "message": "Datos de entrada inv√°lidos",
    "code": "VALIDATION_ERROR",
    "errors": [
        {
            "field": "email",
            "message": "El email es requerido"
        }
    ]
}
```

#### **401 - Unauthorized:**
```json
{
    "status": "error",
    "message": "Credenciales incorrectas",
    "code": "INVALID_CREDENTIALS"
}
```

#### **403 - Forbidden:**
```json
{
    "status": "error",
    "message": "Cuenta no verificada. Por favor, verifica tu correo electr√≥nico.",
    "code": "ACCOUNT_NOT_VERIFIED"
}
```

#### **404 - Not Found:**
```json
{
    "status": "error",
    "message": "Usuario no encontrado",
    "code": "USER_NOT_FOUND"
}
```

#### **409 - Conflict:**
```json
{
    "status": "error",
    "message": "El correo electr√≥nico ya est√° en uso",
    "code": "USER_EXISTS"
}
```

#### **429 - Too Many Requests:**
```json
{
    "status": "error",
    "message": "Demasiados intentos. Intenta m√°s tarde.",
    "code": "RATE_LIMIT_EXCEEDED"
}
```

#### **500 - Internal Server Error:**
```json
{
    "status": "error",
    "message": "Error interno del servidor",
    "code": "INTERNAL_ERROR"
}
```

---

## üö¶ Rate Limiting

### **Endpoints con Rate Limiting:**

#### **Login:** 5 intentos por IP cada 15 minutos
#### **Forgot Password:** 3 intentos por IP cada hora

### **Headers de Rate Limiting:**
```
X-RateLimit-Limit: 5
X-RateLimit-Remaining: 4
X-RateLimit-Reset: 1640995200
```

---

## ‚úÖ Validaciones

### **Registro:**
- `name`: Requerido, string, 2-50 caracteres
- `lastname`: Requerido, string, 2-50 caracteres
- `email`: Requerido, email v√°lido, √∫nico
- `phone`: Requerido, string, 10-15 caracteres, √∫nico
- `password`: Requerido, string, m√≠nimo 8 caracteres, debe contener may√∫scula, min√∫scula, n√∫mero y s√≠mbolo

### **Login:**
- `email`: Requerido, email v√°lido
- `password`: Requerido, string

### **Cambio de Contrase√±a:**
- `currentPassword`: Requerido, string
- `newPassword`: Requerido, string, m√≠nimo 8 caracteres, debe contener may√∫scula, min√∫scula, n√∫mero y s√≠mbolo

---

## üíª Consideraciones de Frontend

### **1. Almacenamiento de Tokens:**
```javascript
// Almacenar tokens de forma segura
localStorage.setItem('accessToken', response.data.accessToken);
localStorage.setItem('refreshToken', response.data.refreshToken);

// O usar SecureStore en React Native
await SecureStore.setItemAsync('accessToken', response.data.accessToken);
await SecureStore.setItemAsync('refreshToken', response.data.refreshToken);
```

### **2. Interceptor para Renovaci√≥n Autom√°tica:**
```javascript
// Interceptor de Axios para renovar tokens autom√°ticamente
axios.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 401) {
      const refreshToken = localStorage.getItem('refreshToken');
      if (refreshToken) {
        try {
          const response = await axios.post('/api/auth/refresh-token', {
            refreshToken
          });
          
          const { accessToken, refreshToken: newRefreshToken } = response.data.data;
          localStorage.setItem('accessToken', accessToken);
          localStorage.setItem('refreshToken', newRefreshToken);
          
          // Reintentar request original
          error.config.headers.Authorization = `Bearer ${accessToken}`;
          return axios.request(error.config);
        } catch (refreshError) {
          // Refresh fall√≥, redirigir a login
          localStorage.removeItem('accessToken');
          localStorage.removeItem('refreshToken');
          window.location.href = '/login';
        }
      }
    }
    return Promise.reject(error);
  }
);
```

### **3. Manejo de Estados de Usuario:**
```javascript
// Verificar si usuario est√° verificado
if (user.status !== 'active') {
  // Mostrar mensaje de verificaci√≥n
  showVerificationMessage();
}

// Verificar si email est√° verificado
if (!user.emailVerifiedAt) {
  // Mostrar banner de verificaci√≥n
  showEmailVerificationBanner();
}
```

### **4. P√°gina de Verificaci√≥n de Email:**
- **URL:** `https://delixmi-backend.onrender.com/email-verification?token=...`
- **Funcionalidad:** Verificaci√≥n autom√°tica al cargar
- **Estados:** Loading, Success, Error, Already Verified
- **Deep Links:** Soporte para abrir app m√≥vil

### **5. Manejo de Errores Espec√≠ficos:**
```javascript
// Manejar errores espec√≠ficos del backend
const handleAuthError = (error) => {
  switch (error.response?.data?.code) {
    case 'ACCOUNT_NOT_VERIFIED':
      showVerificationModal();
      break;
    case 'INVALID_CREDENTIALS':
      showLoginError('Credenciales incorrectas');
      break;
    case 'RATE_LIMIT_EXCEEDED':
      showRateLimitError();
      break;
    default:
      showGenericError();
  }
};
```

### **6. Logout Completo:**
```javascript
const logout = async () => {
  const refreshToken = localStorage.getItem('refreshToken');
  
  if (refreshToken) {
    try {
      await axios.post('/api/auth/logout', { refreshToken });
    } catch (error) {
      console.error('Error al cerrar sesi√≥n:', error);
    }
  }
  
  // Limpiar almacenamiento local
  localStorage.removeItem('accessToken');
  localStorage.removeItem('refreshToken');
  
  // Redirigir a login
  window.location.href = '/login';
};
```

---

## üîß Configuraci√≥n de Variables de Entorno

### **Backend (.env):**
```env
JWT_SECRET=tu_jwt_secret_aqui
JWT_ACCESS_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN_DAYS=30
SENDGRID_API_KEY=tu_sendgrid_api_key
SENDGRID_FROM_EMAIL=noreply@delixmi.com
FRONTEND_URL=https://tu-frontend.com
```

### **Frontend:**
```env
REACT_APP_API_URL=https://delixmi-backend.onrender.com
REACT_APP_APP_SCHEME=delixmi
```

---

## üì± Soporte M√≥vil

### **Deep Links:**
- **Esquema:** `delixmi://`
- **Verificaci√≥n:** `delixmi://verify-email?token=...`
- **Reset Password:** `delixmi://reset-password?token=...`

### **Universal Links (iOS):**
- Configurar en `apple-app-site-association`
- Dominio: `https://delixmi-backend.onrender.com`

### **App Links (Android):**
- Configurar en `assetlinks.json`
- Dominio: `https://delixmi-backend.onrender.com`

---

## üß™ Testing

### **Endpoints de Testing:**
```http
# Obtener token de verificaci√≥n para testing
GET /api/auth/get-verification-token/:userId
Headers: x-test-key: test
```

### **Datos de Prueba:**
```json
{
  "name": "Test",
  "lastname": "User",
  "email": "test@example.com",
  "phone": "5555555555",
  "password": "Test123!"
}
```

---

## üìû Soporte

Para cualquier duda o problema con la implementaci√≥n, contactar al equipo de backend.

**√öltima actualizaci√≥n:** 17 de Octubre, 2025
**Versi√≥n:** 1.0.0

